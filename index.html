<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wedding RSVP</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 2rem;
      background: #f9f6f2;
      color: #333;
    }
    h1, h2 {
      text-align: center;
    }
    form {
      max-width: 500px;
      margin: 2rem auto;
      display: flex;
      flex-direction: column;
    }
    input, select, textarea, button {
      margin-bottom: 1rem;
      padding: 0.8rem;
      font-size: 1rem;
    }
    #admin {
      margin-top: 4rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
    }
    th, td {
      padding: 0.6rem;
      border: 1px solid #ccc;
      text-align: left;
    }
  </style>
</head>
<body>
  <h1>You're Invited!</h1>
  <p style="text-align:center">Enter your full name to view your invitation</p>
  <form id="lookup-form">
    <input type="text" id="fullName" placeholder="Full Name" required />
    <button type="submit">Find Invitation</button>
  </form>

  <div id="invitation-section" style="display:none;">
    <h2>Your Invitation</h2>
    <p id="invitation-text"></p>
    <form id="rsvp-form">
      <label for="guestCount">Number of Guests Attending:</label>
      <select id="guestCount" required></select>
      <label for="email">Your Email:</label>
      <input type="email" id="email" required />
      <label for="phone">Your Phone Number:</label>
      <input type="text" id="phone" />
      <button type="submit">RSVP</button>
    </form>
  </div>

  <div id="admin">
    <h2>Admin Portal</h2>
    <form id="admin-auth">
      <input type="password" id="admin-password" placeholder="Admin Password" required />
      <button type="submit">Login</button>
    </form>
    <div id="guest-list" style="display:none;">
      <h3>Guest List</h3>
      <table>
        <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>RSVP</th><th>Guest Limit</th><th>Invited</th></tr></thead>
        <tbody id="guest-rows"></tbody>
      </table>
    </div>
  </div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  const supabase = createClient(
    'https://hrshdoeovdocwyxcerey.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhyc2hkb2VvdmRvY3d5eGNlcmV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1ODQyNTEsImV4cCI6MjA3MDE2MDI1MX0.n5x7-0cjS0K7knGXGSjaR0rPG_OUEVmx5loJFSs3niA'
  );

  let currentGuest = null;

  document.getElementById("lookup-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = document.getElementById("fullName").value.trim();

    const { data, error } = await supabase
      .from("guests")
      .select("*")
      .eq("full_name", name)
      .single();

    if (error || !data) {
      alert("Guest not found.");
      return;
    }

    currentGuest = data;
    document.getElementById("invitation-text").innerText = data.invitation_text || "You're invited!";

    const guestCountSelect = document.getElementById("guestCount");
    guestCountSelect.innerHTML = "";
    const limit = currentGuest.guest_limit || 1;
    for(let i = 1; i <= limit; i++) {
      const option = document.createElement("option");
      option.value = i;
      option.textContent = i;
      guestCountSelect.appendChild(option);
    }

    document.getElementById("invitation-section").style.display = "block";
  });

  document.getElementById("rsvp-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("email").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const guestCount = parseInt(document.getElementById("guestCount").value, 10);

    if (guestCount > currentGuest.guest_limit) {
      alert(`You cannot RSVP for more than ${currentGuest.guest_limit} guests.`);
      return;
    }

    const { error } = await supabase
      .from("guests")
      .update({ rsvp_status: "Confirmed", email, phone, guest_count: guestCount })
      .eq("id", currentGuest.id);

    if (error) {
      alert("Failed to RSVP");
      return;
    }

    try {
      await emailjs.send("service_idd3fkn", "template_kgtloh8", {
        to_email: email,
        guest_name: currentGuest.full_name,
        guest_count: guestCount
      });
      alert("RSVP Confirmed! A confirmation email has been sent.");
    } catch (err) {
      alert("RSVP Confirmed, but failed to send confirmation email.");
      console.error("EmailJS error:", err);
    }
  });

  document.getElementById("admin-auth").addEventListener("submit", async (e) => {
    e.preventDefault();
    const password = document.getElementById("admin-password").value;
    if (password !== "skhan") {
      alert("Incorrect password");
      return;
    }

    const { data, error } = await supabase.from("guests").select("*").order("created_at", { ascending: false });
    if (error) {
      alert("Failed to load guest list");
      return;
    }

    const tbody = document.getElementById("guest-rows");
    tbody.innerHTML = "";
    data.forEach(guest => {
      tbody.innerHTML += `
        <tr>
          <td>${guest.full_name}</td>
          <td>${guest.email || ""}</td>
          <td>${guest.phone || ""}</td>
          <td>${guest.rsvp_status}</td>
          <td>${guest.guest_limit}</td>
          <td>${guest.invitation_text || ""}</td>
        </tr>
      `;
    });

    document.getElementById("guest-list").style.display = "block";
  });
</script>

  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script type="text/javascript">
    (function(){
      emailjs.init("RtSgLTRPRpIr-3a8T");
    })();
  </script>
</body>
</html>
